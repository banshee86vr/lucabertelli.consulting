---
import { getLangFromUrl, useTranslations } from "../i18n/utils";
import {
	SECRET_EVENTS_API_PASSWORD,
	SECRET_EVENTS_API_URL,
	SECRET_EVENTS_API_USERNAME,
	SECRET_LOAD_EVENTS,
} from "../../setupEnv";

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);

const contactSlug = `/${lang || ""}/contact`;

let events = [];
try {
	let loadEvents = SECRET_LOAD_EVENTS;
	let apiUrl = SECRET_EVENTS_API_URL;
	let apiUsername = SECRET_EVENTS_API_USERNAME;
	let apiPassword = SECRET_EVENTS_API_PASSWORD;

	if (
		typeof SECRET_LOAD_EVENTS === "undefined" &&
		process.env.SECRET_LOAD_EVENTS
	) {
		loadEvents = process.env.SECRET_LOAD_EVENTS;
	}

	if (
		typeof SECRET_EVENTS_API_URL === "undefined" &&
		process.env.SECRET_EVENTS_API_URL
	) {
		apiUrl = process.env.SECRET_EVENTS_API_URL;
	}

	if (
		typeof SECRET_EVENTS_API_USERNAME === "undefined" &&
		process.env.SECRET_EVENTS_API_USERNAME
	) {
		apiUsername = process.env.SECRET_EVENTS_API_USERNAME;
	}

	if (
		typeof SECRET_EVENTS_API_PASSWORD === "undefined" &&
		process.env.SECRET_EVENTS_API_PASSWORD
	) {
		apiPassword = process.env.SECRET_EVENTS_API_PASSWORD;
	}

	if (loadEvents === "true") {
		const headers = new Headers({
			Authorization: `Basic ${btoa(`${apiUsername}:${apiPassword}`)}`,
		});
		const fetchedEvents = await fetch(apiUrl, {
			headers: headers,
		});

		const responseData = await fetchedEvents.json();
		events = responseData.events
			.filter(
				(event: { startDate: string }) =>
					event.startDate > new Date().toISOString(),
			)
			.sort((a: { startDate: string }, b: { startDate: string }) =>
				a.startDate < b.startDate ? -1 : a.startDate > b.startDate ? 1 : 0,
			)
			.slice(0, 3);
	}
} catch (error) {
	console.debug("Impossible to load events from api.eventitech.it");
	console.debug(error);
	events = [];
}
---

{
  events.length > 0 && (
  <!-- Ticket area start  -->
<div class="lb__ticket plr-100">
  <div class="container">
    <div class="lb__ticket-topwrap">
      <h1 class="lb__innerevent-title2 has_char_anim">
        {t("index.tickets.title")} powered by <a
          href="https://eventitech.it/"
          target="_new"
          ><img
            class="has_fade_anim"
            src="/tickets/eventitech.png"
            alt="Eventitech"
            style="width: 400px;"
          /></a
        >
      </h1>
    </div>
  </div>
  <div class="lb__ticket-items">
    {
      events.map((event: any) => (
        <div
          class="lb__ticket-item bg-white has_fade_anim"
          data-fade-from="left"
          data-delay=".5"
        >
          <span class="circle-1" />
          <span class="circle-2" />
          <div class="lb__ticket-up">
            <div class="lb__ticket-upleft">
              <span class="categ">{event.groups[0]?.name}</span>
              <h2 class="title">
                <a href={event.url} target="_new">
                  {event.name}
                </a>
              </h2>
              <p>
                {new Date(event.startDate).toLocaleDateString(lang, {
                  year: "numeric",
                  month: "short",
                  day: "numeric",
                })}
                {new Date(event.endDate) > new Date(event.startDate) &&
                  -new Date(event.endDate).toLocaleDateString(lang, {
                    year: "numeric",
                    month: "short",
                    day: "numeric",
                  })}
              </p>
              <img
                class="lb__ticket-line1"
                src="/tickets/line-1.png"
                alt="img-1"
              />
            </div>
            <div class="lb__ticket-upright">
              <span class="availble">{event.topics.join(", ")}</span>
            </div>
          </div>
          <div class="lb__ticket-bottom">
            <div class="lb__ticket-address">
              <p>{event.location}</p>
            </div>
            <div class="lb__ticket-link">
              <a href={event.url} target="_new">
                Ticket <img src="/tickets/arrow-up.png" alt="arrow" />
              </a>
            </div>
          </div>
        </div>
      ))
    }
  </div>
</div>
<!-- Ticket area end -->

  )
}