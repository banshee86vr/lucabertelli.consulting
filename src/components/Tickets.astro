---
import { getLangFromUrl, useTranslations } from "../i18n/utils";

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);

let events = [];
try {
	let loadEvents: string | null = null;
	let apiUrl: string | null = null;
	let apiUsername: string | null = null;
	let apiPassword: string | null = null;

	// Try environment variables first (works for both dev and production)
	loadEvents = String(import.meta.env.SECRET_LOAD_EVENTS || process.env.SECRET_LOAD_EVENTS || "");
	apiUrl = String(import.meta.env.SECRET_EVENTS_API_URL || process.env.SECRET_EVENTS_API_URL || "");
	apiUsername = String(import.meta.env.SECRET_EVENTS_API_USERNAME || process.env.SECRET_EVENTS_API_USERNAME || "");
	apiPassword = String(import.meta.env.SECRET_EVENTS_API_PASSWORD || process.env.SECRET_EVENTS_API_PASSWORD || "");

	// If env vars are not set, try Cloudflare KV
	if (!loadEvents || loadEvents === "" || !apiUrl || apiUrl === "" || !apiUsername || apiUsername === "" || !apiPassword || apiPassword === "") {
		const lbKV = Astro.locals?.runtime?.env?.lb_consulting;
		if (lbKV) {
			console.log("[Tickets] Env vars not found or empty, trying Cloudflare KV");
			loadEvents = loadEvents && loadEvents !== "" ? loadEvents : (await lbKV.get("SECRET_LOAD_EVENTS")) || "";
			apiUrl = apiUrl && apiUrl !== "" ? apiUrl : (await lbKV.get("SECRET_EVENTS_API_URL")) || "";
			apiUsername = apiUsername && apiUsername !== "" ? apiUsername : (await lbKV.get("SECRET_EVENTS_API_USERNAME")) || "";
			apiPassword = apiPassword && apiPassword !== "" ? apiPassword : (await lbKV.get("SECRET_EVENTS_API_PASSWORD")) || "";
		}
	}

	if (loadEvents === "true" && apiUrl && apiUrl !== "" && apiUsername && apiUsername !== "" && apiPassword && apiPassword !== "") {
		console.log("[Tickets] Fetching events from API...");
		const headers = new Headers({
			Authorization: `Basic ${btoa(`${apiUsername}:${apiPassword}`)}`,
		});
		const fetchedEvents = await fetch(apiUrl, {
			headers: headers,
		});

		console.log("[Tickets] API Response Status:", fetchedEvents.status);
		const responseData = await fetchedEvents.json();
		console.log("[Tickets] Response data:", responseData);

		if (responseData.events && Array.isArray(responseData.events)) {
			events = responseData.events
				.filter(
					(event: { startDate: string }) =>
						event.startDate > new Date().toISOString(),
				)
				.sort((a: { startDate: string }, b: { startDate: string }) =>
					a.startDate < b.startDate ? -1 : a.startDate > b.startDate ? 1 : 0,
				)
				.slice(0, 3);
			console.log("[Tickets] Filtered events:", events.length);
		}
	} else {
		console.log("[Tickets] Conditions not met for API fetch");
		console.log("[Tickets] loadEvents === 'true':", loadEvents === "true");
		console.log("[Tickets] apiUrl available:", !!apiUrl);
		console.log("[Tickets] apiUsername available:", !!apiUsername);
		console.log("[Tickets] apiPassword available:", !!apiPassword);
	}
} catch (error) {
	console.error("[Tickets] Error loading events from api.eventitech.it");
	console.error(error);
	events = [];
}
---

{
  events.length > 0 && (
  <!-- Ticket area start  -->
<section class="lb__ticket plr-100">
  <div class="container">
    <div class="lb__ticket-topwrap">
      <div class="lb__ticket-header-container">
        <h1 class="lb__innerevent-title2 has_char_anim">
          {t("index.tickets.title")}
        </h1>
        <div class="lb__ticket-logo-container">
          <span class="lb__ticket-powered-label">powered by</span>
          <a
            href="https://eventitech.it/"
            target="_new"
            class="lb__ticket-logo-link"
          >
            <picture>
              <source media="(max-width: 768px)" srcset="/tickets/eventitech.png?format=webp&w=280 1x, /tickets/eventitech.png?format=webp&w=560 2x" type="image/webp" />
              <source media="(max-width: 768px)" srcset="/tickets/eventitech.png?w=280 1x, /tickets/eventitech.png?w=560 2x" />
              <source srcset="/tickets/eventitech.png?format=webp&w=400 1x, /tickets/eventitech.png?format=webp&w=800 2x" type="image/webp" />
              <img
                class="has_fade_anim"
                src="/tickets/eventitech.png?w=400"
                alt="Eventitech"
                decoding="async"
              />
            </picture>
          </a>
        </div>
      </div>
    </div>
  </div>
  <div class="lb__ticket-items">
    {
      events.map((event: any) => (
        <div
          class="lb__ticket-item bg-white has_fade_anim"
          data-fade-from="left"
          data-delay=".5"
        >
          <span class="circle-1" />
          <span class="circle-2" />
          <div class="lb__ticket-up">
            <div class="lb__ticket-upleft">
              <span class="categ">{event.groups[0]?.name}</span>
              <h2 class="title">
                <a href={event.url} target="_new">
                  {event.name}
                </a>
              </h2>
              <p>
                {new Date(event.startDate).toLocaleDateString(lang, {
                  year: "numeric",
                  month: "short",
                  day: "numeric",
                })}
                {new Date(event.endDate) > new Date(event.startDate) &&
                  " - " + new Date(event.endDate).toLocaleDateString(lang, {
                    year: "numeric",
                    month: "short",
                    day: "numeric",
                  })}
              </p>
              <img
                class="lb__ticket-line1"
                src="/tickets/line-1.png"
                alt="img-1"
              />
            </div>
            <div class="lb__ticket-upright">
              <span class="availble">{event.topics.join(", ")}</span>
            </div>
          </div>
          <div class="lb__ticket-bottom">
            <div class="lb__ticket-address">
              <p>{event.location}</p>
            </div>
            <div class="lb__ticket-link">
              <a href={event.url} target="_new">
                Ticket <img src="/tickets/arrow-up.png" alt="arrow" />
              </a>
            </div>
          </div>
        </div>
      ))
    }
  </div>
</section>
<!-- Ticket area end -->
  )
}
